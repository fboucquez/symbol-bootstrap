#!/bin/bash
set -e

name=$1
mode=$2
application="broker"
theOtherApplication="server"
config="./$application-config"

echo "RUNNING $application $name $mode"
export LD_LIBRARY_PATH=/usr/catapult/lib:/usr/catapult/deps

ulimit -c unlimited

rm -f "{{{dataDirectory}}}/$application.started"
rm -f "{{{dataDirectory}}}/$application-recovery.started"

if [ "$mode" == "DEBUG" ]; then
  echo "Setting up core dump..."
  mkdir -p ./logs
  echo "./logs/$application.%e.%t" >/proc/sys/kernel/core_pattern
fi

if [ -e "{{{dataDirectory}}}/$application.lock" ]; then
  echo "!!!! Have lock file present, going to run recovery in $application mode...."

  while [ -f "{{{dataDirectory}}}/$theOtherApplication-recovery.started" ] ;
  do
      echo "Waiting for $theOtherApplication recovery to finish"
      sleep 1
  done

  touch "{{{dataDirectory}}}/$application-recovery.started"
  {{{catapultAppFolder}}}/bin/catapult.recovery "$config"
  echo "!!!! Finished running recovery, should be moving on to start $application..."
fi

rm -f "{{{dataDirectory}}}/recovery.lock"
rm -f "{{{dataDirectory}}}/$application.lock"
rm -f "{{{dataDirectory}}}/$application-recovery.started"

touch "{{{dataDirectory}}}/$application.started"

{{{catapultAppFolder}}}/bin/catapult.broker "$config"
